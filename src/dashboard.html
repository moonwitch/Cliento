<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Mijn Dashboard | Cliento</title>
        <link rel="stylesheet" href="css/style.css" />
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="config.js"></script>
    </head>
    <body>
        <nav
            style="
                padding: 1rem;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
            "
        >
            <span><strong>Cliento</strong> Dashboard</span>
            <div>
                <a href="treatments.html" style="margin-right: 1rem"
                    >Boek Nieuwe Afspraak</a
                >
                <button
                    onclick="handleLogout()"
                    class="btn-secondary"
                    style="font-size: 0.8rem"
                >
                    Uitloggen
                </button>
            </div>
        </nav>

        <div class="container" style="max-width: 800px; margin: 2rem auto">
            <h1>Welkom, <span id="user-email">...</span></h1>

            <div class="card" style="margin-top: 2rem">
                <h2>Mijn Afspraken</h2>
                <div id="appointments-list">
                    <p>Laden...</p>
                </div>
            </div>
        </div>

        <script>
            async function initDashboard() {
                // 1. Check Sessie
                const {
                    data: { session },
                } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = "index.html";
                    return;
                }
                document.getElementById("user-email").innerText =
                    session.user.email;

                // 2. Haal Client ID op
                const { data: client } = await supabaseClient
                    .from("clients")
                    .select("id")
                    .eq("user_id", session.user.id)
                    .single();

                if (!client) {
                    document.getElementById("appointments-list").innerHTML =
                        "<p>Geen klantprofiel gevonden.</p>";
                    return;
                }

                // 3. Haal Afspraken op
                const { data: appointments, error } = await supabaseClient
                    .from("appointments")
                    .select("*")
                    .eq("client_id", client.id)
                    .order("start_time", { ascending: true });

                const list = document.getElementById("appointments-list");
                list.innerHTML = ""; // Leegmaken

                if (error) {
                    list.innerHTML =
                        "<p style='color:red'>Kon afspraken niet laden.</p>";
                    return;
                }

                if (appointments.length === 0) {
                    list.innerHTML =
                        "<p>Je hebt nog geen afspraken gepland.</p>";
                    return;
                }

                // 4. Toon Afspraken
                appointments.forEach((app) => {
                    const date = new Date(app.start_time).toLocaleString(
                        "nl-BE",
                        {
                            weekday: "short",
                            day: "numeric",
                            month: "long",
                            hour: "2-digit",
                            minute: "2-digit",
                        },
                    );

                    const item = `
                    <div style="border-bottom: 1px solid #eee; padding: 1rem 0; display:flex; justify-content:space-between;">
                        <div>
                            <strong>${date}</strong><br>
                            <span style="color:#666;">Behandeling (ID: ${app.client_id})</span>
                        </div>
                        <div>
                            <span style="background: #e6f4ea; color: #1e7e34; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                                ${app.status}
                            </span>
                        </div>
                    </div>
                `;
                    list.innerHTML += item;
                });
            }

            async function handleLogout() {
                await supabaseClient.auth.signOut();
                window.location.href = "index.html";
            }

            initDashboard();
        </script>
    </body>
</html>

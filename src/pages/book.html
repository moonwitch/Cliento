<!doctype html>
<html lang="nl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Boek Afspraak | Cliento</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="../js/config.js" defer></script>
    <script src="../js/loader.js" defer></script>
    <script src="../js/auth.js" defer></script>
    <script src="../js/auth-modal.js" defer></script>
    <script src="../js/header.js" defer></script>
    <script src="../js/app.js" defer></script>
</head>

<body>
    <div id="site-header"></div>
    <div id="auth-modal-slot"></div>

    <div style="max-width: 800px; margin: 1rem auto 0; padding: 0 1rem;">
        <a href="treatments.html" style="text-decoration:none; color: var(--brand-primary);">&larr; Terug naar
            Behandelingen</a>
    </div>

    <div class="auth-wrapper">
        <div class="auth-card" style="max-width: 600px">
            <h1>Bevestig je Boeking</h1>

            <div id="summary" style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                <p><strong>Behandeling:</strong> <span id="t-name">Laden...</span></p>
                <p><strong>Prijs:</strong> â‚¬ <span id="t-price">...</span></p>
                <p><strong>Duur:</strong> <span id="t-duration">...</span> min</p>
            </div>

            <form id="booking-form" onsubmit="handleBooking(event)">
                <label>Kies een Datum</label>
                <input type="date" id="date" required style="width: 100%; padding: 10px; margin-bottom: 1rem" />

                <label>Kies een Tijdstip</label>
                <input type="time" id="time" required style="width: 100%; padding: 10px; margin-bottom: 1rem" />

                <button type="submit" class="btn-primary" style="width: 100%">Afspraak Bevestigen</button>
            </form>

            <p id="msg" style="margin-top: 1rem; text-align: center; font-weight: bold;"></p>
        </div>
    </div>

    <div id="site-footer"></div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            init();
        });

        let selectedTreatment = null;

        async function init() {
            const {data: {session}} = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = "../index.html";
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const treatmentId = params.get("treatment");

            if (!treatmentId) {
                document.getElementById("msg").innerText = "Geen behandeling geselecteerd.";
                return;
            }

            const {data: treatment} = await supabaseClient
                .from("treatments")
                .select("*")
                .eq("id", treatmentId)
                .single();

            if (treatment) {
                selectedTreatment = treatment;
                document.getElementById("t-name").innerText = treatment.title;
                document.getElementById("t-price").innerText = treatment.price;
                document.getElementById("t-duration").innerText = treatment.duration_minutes;
            }

            document.getElementById("date").min = new Date().toISOString().split("T")[0];
        }

        async function handleBooking(e) {
            e.preventDefault();
            const msg = document.getElementById("msg");
            msg.innerText = "Bezig met boeken...";
            msg.style.color = "#666";

            const dateVal = document.getElementById("date").value;
            const timeVal = document.getElementById("time").value;
            const fullDateTime = new Date(`${dateVal}T${timeVal}`);

            const {data: {user}} = await supabaseClient.auth.getUser();

            const {data: clientData, error: clientError} = await supabaseClient
                .from("clients")
                .select("id")
                .eq("user_id", user.id)
                .single();

            if (clientError || !clientData) {
                msg.innerText = "Fout: Kon je klantprofiel niet vinden.";
                msg.style.color = "red";
                return;
            }

            const {error: bookingError} = await supabaseClient
                .from("appointments")
                .insert({
                    client_id: clientData.id,
                    treatment_title: selectedTreatment.title,
                    start_time: fullDateTime.toISOString(),
                    status: "confirmed",
                });

            if (bookingError) {
                msg.innerText = "Boeking mislukt: " + bookingError.message;
                msg.style.color = "red";
            } else {
                msg.innerText = "Gelukt! Je wordt doorgestuurd...";
                msg.style.color = "green";
                setTimeout(() => (window.location.href = "../user-dashboard.html"), 1500);
            }
        }
    </script>
</body>

</html>
